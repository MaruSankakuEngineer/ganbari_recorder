import 'package:flutter/material.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:timezone/data/latest_all.dart' as tz;
import 'package:timezone/timezone.dart' as tz;
import 'package:shared_preferences/shared_preferences.dart';
import 'package:device_info_plus/device_info_plus.dart';
import 'package:table_calendar/table_calendar.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  tz.initializeTimeZones();
  tz.setLocalLocation(tz.getLocation('Asia/Tokyo'));

  final notificationService = NotificationService();
  await notificationService.init();
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: HomeScreen(),
    );
  }
}

class HomeScreen extends StatefulWidget {
  @override
  _HomeScreenState createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  final NotificationService _notificationService = NotificationService();
  Map<String, String> recordMap = {};
  DateTime focusedDay = DateTime.now();

  @override
  void initState() {
    super.initState();
    _loadRecords();

    _notificationService.onRecordAdded = (String result) {
      _addRecord(result);
    };

    _notificationService.scheduleDailyNotification();
  }

  void _loadRecords() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    List<String> records = prefs.getStringList('records') ?? [];
    Map<String, String> map = {};
    for (var record in records) {
      final match = RegExp(r"Ë®òÈå≤Êó•: (\d{4}-\d{2}-\d{2}) - (.+)").firstMatch(record);
      if (match != null) {
        map[match.group(1)!] = match.group(2)!;
      }
    }
    setState(() {
      recordMap = map;
    });
  }

  void _addRecord(String result) async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    String date = DateTime.now().toIso8601String().split('T')[0];
    recordMap[date] = result;
    List<String> records = recordMap.entries
        .map((entry) => "Ë®òÈå≤Êó•: ${entry.key} - ${entry.value}")
        .toList();
    await prefs.setStringList('records', records);
    setState(() {});
  }

  void _deleteRecordByDate(String date) async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    recordMap.remove(date);
    List<String> records = recordMap.entries
        .map((entry) => "Ë®òÈå≤Êó•: ${entry.key} - ${entry.value}")
        .toList();
    await prefs.setStringList('records', records);
    setState(() {});
  }

  void _clearRecords() async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    await prefs.remove('records');
    setState(() {
      recordMap.clear();
    });
  }

  Future<void> _addRecordForDate(String date, String result) async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    recordMap[date] = result;
    List<String> records = recordMap.entries
        .map((entry) => "Ë®òÈå≤Êó•: ${entry.key} - ${entry.value}")
        .toList();
    await prefs.setStringList('records', records);
    setState(() {});
  }

  Map<String, int> _countWinLossThisMonth() {
    final int year = focusedDay.year;
    final int month = focusedDay.month;

    int win = 0;
    int loss = 0;

    recordMap.forEach((key, value) {
      final date = DateTime.tryParse(key);
      if (date != null && date.year == year && date.month == month) {
        if (value == 'Âãù„Å°') win++;
        if (value == 'Ë≤†„Åë') loss++;
      }
    });

    return {'Âãù„Å°': win, 'Ë≤†„Åë': loss};
  }

  Widget _monthlyWinLossBarWidget() {
    final counts = _countWinLossThisMonth();
    final int win = counts['Âãù„Å°']!;
    final int loss = counts['Ë≤†„Åë']!;
    final int total = win + loss;

    if (total == 0) {
      return Text(
        "${focusedDay.month}Êúà„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì",
        style: TextStyle(fontSize: 16),
      );
    }

    final double winRatio = win / total;

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          "${focusedDay.month}Êúà„ÅÆÂãù„Å°Ë≤†„ÅëÔºö Âãù„Å°: $win / Ë≤†„Åë: $loss",
          style: TextStyle(fontSize: 16),
        ),
        SizedBox(height: 8),
        Stack(
          children: [
            Container(
              height: 20,
              decoration: BoxDecoration(
                color: Colors.red.shade300,
                borderRadius: BorderRadius.circular(10),
              ),
            ),
            FractionallySizedBox(
              alignment: Alignment.centerLeft,
              widthFactor: winRatio,
              child: Container(
                height: 20,
                decoration: BoxDecoration(
                  color: Colors.green.shade400,
                  borderRadius: BorderRadius.circular(10),
                ),
              ),
            ),
          ],
        ),
      ],
    );
  }



  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text("È†ëÂºµ„ÇäË®òÈå≤")),
      body: Column(
        children: [
          TableCalendar(
              firstDay: DateTime.utc(2020, 1, 1),
              lastDay: DateTime.utc(2030, 12, 31),
              focusedDay: focusedDay,
              calendarFormat: CalendarFormat.month,
              onDaySelected: (selectedDay, newFocusedDay) {
                setState(() {
                  focusedDay = newFocusedDay;
                });

              String key = selectedDay.toIso8601String().split('T')[0];
              String? result = recordMap[key];

              showDialog(
                context: context,
                builder: (_) => AlertDialog(
                  title: Text("Ë®òÈå≤"),
                  content: Text(result != null
                      ? "$key „ÅÆË®òÈå≤: $result"
                      : "$key „Å´Ë®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ"),
                  actions: [
                    if (result == null) ...[
                      TextButton(
                        onPressed: () async {
                          await _addRecordForDate(key, "Âãù„Å°");
                          Navigator.pop(context);
                        },
                        child: Text("Âãù„Å°„Å®„Åó„Å¶Ë®òÈå≤"),
                      ),
                      TextButton(
                        onPressed: () async {
                          await _addRecordForDate(key, "Ë≤†„Åë");
                          Navigator.pop(context);
                        },
                        child: Text("Ë≤†„Åë„Å®„Åó„Å¶Ë®òÈå≤"),
                      ),
                    ],
                    TextButton(
                      onPressed: () => Navigator.pop(context),
                      child: Text("OK"),
                    ),
                  ],
                ),
              );
            },
            onPageChanged: (newFocusedDay) {
              setState(() {
                focusedDay = newFocusedDay;
              });
            },
            calendarBuilders: CalendarBuilders(
              defaultBuilder: (context, day, focusedDay) {
                final dateKey = day.toIso8601String().split('T')[0];
                final result = recordMap[dateKey];

                if (result != null) {
                  String emoji = result == 'Âãù„Å°' ? 'üü¢' : 'üî¥';

                  return Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Text(
                        '${day.day}',
                        style: TextStyle(fontSize: 14),
                      ),
                      Text(
                        emoji,
                        style: TextStyle(fontSize: 14),
                      ),
                    ],
                  );
                }

                return null;
              },
            ),
          ),
          SizedBox(height: 20),
          _monthlyWinLossBarWidget(),
          SizedBox(height: 20),
        ],
      ),
    );
  }
}

class NotificationService {
  static final NotificationService _instance = NotificationService._internal();
  factory NotificationService() => _instance;
  NotificationService._internal();

  final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
      FlutterLocalNotificationsPlugin();

  void Function(String result)? onRecordAdded;

  Future<void> init() async {
    const AndroidInitializationSettings androidInitSettings =
        AndroidInitializationSettings('@mipmap/ic_launcher');

    final InitializationSettings initSettings =
        InitializationSettings(android: androidInitSettings);

    await flutterLocalNotificationsPlugin.initialize(
      initSettings,
      onDidReceiveNotificationResponse: (details) {
        final actionId = details.actionId;

        if (details.notificationResponseType ==
            NotificationResponseType.selectedNotificationAction) {
          if (actionId == 'yes_action') {
            _saveRecord('Âãù„Å°');
          } else if (actionId == 'no_action') {
            _saveRecord('Ë≤†„Åë');
          }
        }
      },
    );
    scheduleDailyNotification();
    await requestExactAlarmPermission();
  }

  Future<void> requestExactAlarmPermission() async {
    final DeviceInfoPlugin deviceInfo = DeviceInfoPlugin();
    final AndroidDeviceInfo androidInfo = await deviceInfo.androidInfo;

    if (androidInfo.version.sdkInt >= 31) {
      final permission = await flutterLocalNotificationsPlugin
          .resolvePlatformSpecificImplementation<
              AndroidFlutterLocalNotificationsPlugin>()
          ?.requestExactAlarmsPermission();

      if (permission == true) {
        print("üîî Ê≠£Á¢∫„Å™„Ç¢„É©„Éº„É†„ÅÆÊ®©Èôê„ÅåË®±ÂèØ„Åï„Çå„Åæ„Åó„Åü");
      } else {
        print("‚ö†Ô∏è Ê≠£Á¢∫„Å™„Ç¢„É©„Éº„É†„ÅÆÊ®©Èôê„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü");
      }
    }
  }

  String getRandomMessage() {
    final messages = [
      '‰ªäÊó•„ÄÅ„ÇÑ„Çã„Åπ„Åç„Åì„Å®„Å´Âèñ„ÇäÁµÑ„ÇÅ„ÅüÔºü',
      'Â∞ë„Åó„Åß„ÇÇÂâç„Å´ÈÄ≤„ÇÅ„Åü„Å£„Å¶ÊÑü„Åò„ÅüÔºü',
      '‰Ωï„Åã‰∏ÄÊ≠©ÈÄ≤„ÇÅ„ÅüÔºü',
      'Ëá™ÂàÜ„Å®„ÅÆÁ¥ÑÊùü„ÇíÂÆà„Çå„ÅüÔºü',
      'Êò®Êó•„Çà„Çä„Å°„Çá„Å£„Å®„Å†„ÅëÊàêÈï∑„Åß„Åç„ÅüÔºü',
      '‰ªäÊó•„ÅÆËá™ÂàÜ„ÇíË§í„ÇÅ„Çâ„Çå„ÇãÔºü',
      '‰∏ÄÊó•„ÇíËá™ÂàÜ„Çâ„Åó„ÅèÈÅé„Åî„Åõ„ÅüÔºü',
      'Â∞è„Åï„Å™ÈÅîÊàêÊÑü„ÄÅÂë≥„Çè„Åà„ÅüÔºü',
      '‰ªäÊó•„ÅØ„Äå„ÇÑ„Çä„Åç„Å£„Åü„Äç„Å£„Å¶ÊÄù„Åà„ÅüÔºü',
      '‰ªä„ÅÆËá™ÂàÜ„Å´„Åß„Åç„Çã„Åì„Å®„Çí„ÇÑ„Å£„ÅüÔºü'
    ];
    messages.shuffle();
    return messages.first;
  }

  void scheduleDailyNotification() async {
    print("üîî scheduleDailyNotification() „ÇíÈñãÂßã");

    final location = tz.getLocation('Asia/Tokyo');
    final now = tz.TZDateTime.now(location);

    tz.TZDateTime scheduledDate = tz.TZDateTime(
      location,
      now.year,
      now.month,
      now.day,
      23,
      0,
    );

    if (now.isAfter(scheduledDate)) {
      scheduledDate = scheduledDate.add(Duration(days: 1));
    }

    print("üìÖ ÁèæÂú®ÊôÇÂàª: $now");
    print("üìÖ ÈÄöÁü•‰∫àÂÆöÊôÇÂàªÔºàÊØéÊó•23ÊôÇÔºâ: $scheduledDate");

    const AndroidNotificationDetails androidDetails = AndroidNotificationDetails(
      'daily_notify',
      'Daily Notifications',
      channelDescription: 'ÊØéÊó•23ÊôÇ„ÅÆÁøíÊÖ£ÈÄöÁü•',
      importance: Importance.high,
      priority: Priority.high,
      actions: [
        AndroidNotificationAction(
          'yes_action',
          'Yes',
          showsUserInterface: true,
        ),
        AndroidNotificationAction(
          'no_action',
          'No',
          showsUserInterface: true,
        ),
      ],
    );

    const NotificationDetails details = NotificationDetails(android: androidDetails);

    try {
      await flutterLocalNotificationsPlugin.zonedSchedule(
        0,
        '‰ªäÊó•„ÅÆÈ†ëÂºµ„Çä',
        getRandomMessage(),
        scheduledDate,
        details,
        androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
        matchDateTimeComponents: DateTimeComponents.time,
      );
      print("‚úÖ ÈÄöÁü•„Çπ„Ç±„Ç∏„É•„Éº„É´ÂÆå‰∫Ü: $scheduledDate");
    } catch (e) {
      print("‚ùå ÈÄöÁü•„Çπ„Ç±„Ç∏„É•„Éº„É´Â§±Êïó: $e");
    }
  }

  void _saveRecord(String response) async {
    SharedPreferences prefs = await SharedPreferences.getInstance();
    List<String> records = prefs.getStringList('records') ?? [];
    String date = DateTime.now().toIso8601String().split('T')[0];
    records.removeWhere((record) => record.startsWith("Ë®òÈå≤Êó•: $date -"));
    records.add("Ë®òÈå≤Êó•: $date - $response");
    await prefs.setStringList('records', records);
    onRecordAdded?.call(response);
  }
}
